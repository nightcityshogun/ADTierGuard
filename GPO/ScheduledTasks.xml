<?xml version="1.0" encoding="utf-8"?>
<!--
    ADTierGuard GPO Scheduled Tasks Template
    
    Variables to replace before import:
    #ScriptPath  - SYSVOL scripts path (e.g., \\contoso.com\SYSVOL\contoso.com\scripts)
    #GMSAName    - Group Managed Service Account name (e.g., ADTierGuard-svc)
    
    These are replaced automatically by Install-ADTierGuard.ps1
-->
<ScheduledTasks clsid="{CC63F200-7309-4ba0-B154-A71CD118DBCC}">
  <!-- Tier 0 Computer Sync - Runs as SYSTEM every 10 minutes -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="ADTierGuard - Tier 0 Computer Sync" image="2" changed="2025-01-01 00:00:00" uid="{B1168190-7E2C-4177-9391-B1FFBCDF4001}" disabled="0">
    <Properties action="U" name="ADTierGuard - Tier 0 Computer Sync" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>ADTierGuard</Author>
          <Description>Manages Tier 0 computer group membership. Adds computers in Tier 0 OUs to the Tier 0 Computers group for Kerberos Authentication Policy enforcement.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#ScriptPath\Invoke-TierComputerSync.ps1" -TierLevel 0</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 1 Computer Sync - Runs as SYSTEM every 10 minutes -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="ADTierGuard - Tier 1 Computer Sync" image="2" changed="2025-01-01 00:00:00" uid="{D9E485BC-145A-47BC-B6C0-A3457662E002}" disabled="0">
    <Properties action="U" name="ADTierGuard - Tier 1 Computer Sync" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>ADTierGuard</Author>
          <Description>Manages Tier 1 computer group membership. Adds computers in Tier 1 OUs to the Tier 1 Computers group for Kerberos Authentication Policy enforcement.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#ScriptPath\Invoke-TierComputerSync.ps1" -TierLevel 1</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:05:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 0 User Sync - Runs as GMSA, DISABLED by default for safety -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="ADTierGuard - Tier 0 User Sync" image="2" changed="2025-01-01 00:00:00" uid="{54CA3192-AF32-4C83-98BF-370533359003}" disabled="1">
    <Properties action="U" name="ADTierGuard - Tier 0 User Sync" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>ADTierGuard</Author>
          <Description>Applies Kerberos Authentication Policy to Tier 0 users, adds them to Protected Users, and cleans up privileged group membership. DISABLED by default - enable after verifying computer sync works.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>LeastPrivilege</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#ScriptPath\Invoke-TierUserSync.ps1" -TierLevel 0</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT1H</RandomDelay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 1 User Sync - Runs as GMSA, DISABLED by default for safety -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="ADTierGuard - Tier 1 User Sync" image="2" changed="2025-01-01 00:00:00" uid="{019C1A3C-7B7A-4C6B-8A81-5DF205198004}" disabled="1">
    <Properties action="U" name="ADTierGuard - Tier 1 User Sync" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>ADTierGuard</Author>
          <Description>Applies Kerberos Authentication Policy to Tier 1 users. DISABLED by default - enable after verifying computer sync works.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>LeastPrivilege</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT10M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>true</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>true</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>true</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <RunOnlyIfIdle>false</RunOnlyIfIdle>
          <WakeToRun>false</WakeToRun>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#ScriptPath\Invoke-TierUserSync.ps1" -TierLevel 1</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT1H</RandomDelay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- GMSA Context Switch - Changes User Sync tasks to run as GMSA (Pure ADSI) -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="ADTierGuard - GMSA Context Switch" image="2" changed="2025-01-01 00:00:00" uid="{832DD5A2-5AA7-4F99-8663-0D4855E5DA05}">
    <Properties action="U" name="ADTierGuard - GMSA Context Switch" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>ADTierGuard</Author>
          <Description>Changes User Sync scheduled tasks to run as GMSA instead of SYSTEM. Uses pure ADSI - no ActiveDirectory module required. Runs hourly and on GPO refresh.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>true</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT10M</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#ScriptPath\Set-GMSAContext.ps1" -GMSAName "#GMSAName"</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT30M</RandomDelay>
            <Repetition>
              <Interval>PT1H</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
          <EventTrigger>
            <Enabled>true</Enabled>
            <Subscription>&lt;QueryList&gt;&lt;Query Id="0" Path="System"&gt;&lt;Select Path="System"&gt;*[System[Provider[@Name='Microsoft-Windows-GroupPolicy'] and EventID=1502]]&lt;/Select&gt;&lt;/Query&gt;&lt;/QueryList&gt;</Subscription>
          </EventTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>
</ScheduledTasks>
