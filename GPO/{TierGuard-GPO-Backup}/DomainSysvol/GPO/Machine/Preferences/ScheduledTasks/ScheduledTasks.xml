<?xml version="1.0" encoding="utf-8"?>
<ScheduledTasks clsid="{CC63F200-7309-4ba0-B154-A71CD118DBCC}">
  <!-- 
    TierGuard Scheduled Tasks GPO Template
    
    Replace these placeholders before import:
    #SCRIPT_PATH# = UNC path to TierGuard scripts (e.g., \\contoso.com\SYSVOL\contoso.com\scripts\TierGuard)
    #GMSA_NAME#   = GMSA SAM account name without $ (e.g., TierGuard-Svc)
  -->
  
  <!-- Tier 0 Computer Sync - Runs as SYSTEM -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="TierGuard Computer Sync - Tier 0" image="2" changed="2025-01-01 00:00:00" uid="{A1B2C3D4-E5F6-4A5B-8C9D-0E1F2A3B4C5D}" disabled="0">
    <Properties action="U" name="TierGuard Computer Sync - Tier 0" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>TierGuard</Author>
          <Description>Synchronizes Tier 0 computer objects to the TierGuard computer group for Kerberos Authentication Policy claims.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#SCRIPT_PATH#\Sync-TierComputers.ps1" -Scope Tier-0</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 1 Computer Sync - Runs as SYSTEM -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="TierGuard Computer Sync - Tier 1" image="2" changed="2025-01-01 00:00:00" uid="{B2C3D4E5-F6A7-5B6C-9D0E-1F2A3B4C5D6E}" disabled="0">
    <Properties action="U" name="TierGuard Computer Sync - Tier 1" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>TierGuard</Author>
          <Description>Synchronizes Tier 1 computer objects to the TierGuard computer group for Kerberos Authentication Policy claims.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#SCRIPT_PATH#\Sync-TierComputers.ps1" -Scope Tier-1</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:05:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 0 User Sync - Runs as GMSA (DISABLED by default) -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="TierGuard User Sync - Tier 0" image="2" changed="2025-01-01 00:00:00" uid="{C3D4E5F6-A7B8-6C7D-0E1F-2A3B4C5D6E7F}" disabled="1">
    <Properties action="U" name="TierGuard User Sync - Tier 0" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>TierGuard</Author>
          <Description>Applies Kerberos Authentication Policy to Tier 0 administrators. DISABLED by default - enable after computer sync is verified.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#SCRIPT_PATH#\Sync-TierUsers.ps1" -Scope Tier-0</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:02:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT5M</RandomDelay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- Tier 1 User Sync - Runs as GMSA (DISABLED by default) -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="TierGuard User Sync - Tier 1" image="2" changed="2025-01-01 00:00:00" uid="{D4E5F6A7-B8C9-7D8E-1F2A-3B4C5D6E7F8A}" disabled="1">
    <Properties action="U" name="TierGuard User Sync - Tier 1" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>TierGuard</Author>
          <Description>Applies Kerberos Authentication Policy to Tier 1 administrators. DISABLED by default - enable after computer sync is verified.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT1H</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -NonInteractive -File "#SCRIPT_PATH#\Sync-TierUsers.ps1" -Scope Tier-1</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:07:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT5M</RandomDelay>
            <Repetition>
              <Interval>PT10M</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

  <!-- GMSA Context Switch - Updates user tasks to run as GMSA -->
  <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="TierGuard GMSA Context Switch" image="2" changed="2025-01-01 00:00:00" uid="{E5F6A7B8-C9D0-8E9F-2A3B-4C5D6E7F8A9B}" disabled="0">
    <Properties action="U" name="TierGuard GMSA Context Switch" runAs="NT AUTHORITY\System" logonType="S4U">
      <Task version="1.2">
        <RegistrationInfo>
          <Author>TierGuard</Author>
          <Description>Changes User Sync tasks to run as GMSA and updates GMSA principals. Runs on GPO refresh and hourly.</Description>
        </RegistrationInfo>
        <Principals>
          <Principal id="Author">
            <UserId>NT AUTHORITY\System</UserId>
            <LogonType>S4U</LogonType>
            <RunLevel>HighestAvailable</RunLevel>
          </Principal>
        </Principals>
        <Settings>
          <IdleSettings>
            <Duration>PT5M</Duration>
            <WaitTimeout>PT1H</WaitTimeout>
            <StopOnIdleEnd>false</StopOnIdleEnd>
            <RestartOnIdle>false</RestartOnIdle>
          </IdleSettings>
          <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy>
          <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries>
          <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries>
          <AllowHardTerminate>false</AllowHardTerminate>
          <AllowStartOnDemand>true</AllowStartOnDemand>
          <Enabled>true</Enabled>
          <Hidden>false</Hidden>
          <ExecutionTimeLimit>PT10M</ExecutionTimeLimit>
          <Priority>7</Priority>
        </Settings>
        <Actions Context="Author">
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -Command "$GMSA = Get-ADServiceAccount -Identity '#GMSA_NAME#'; $principal = New-ScheduledTaskPrincipal -LogonType Password -UserId $GMSA.SID; Set-ScheduledTask 'TierGuard User Sync - Tier 0' -Principal $principal -ErrorAction SilentlyContinue; Set-ScheduledTask 'TierGuard User Sync - Tier 1' -Principal $principal -ErrorAction SilentlyContinue"</Arguments>
          </Exec>
          <Exec>
            <Command>powershell.exe</Command>
            <Arguments>-ExecutionPolicy Bypass -NoProfile -Command "$DCGroup = (Get-ADDomain).DomainSID.Value + '-516'; $DCs = Get-ADGroupMember -Identity $DCGroup | Select-Object -ExpandProperty SamAccountName; Set-ADServiceAccount -Identity '#GMSA_NAME#' -PrincipalsAllowedToRetrieveManagedPassword $DCs -ErrorAction SilentlyContinue"</Arguments>
          </Exec>
        </Actions>
        <Triggers>
          <CalendarTrigger>
            <StartBoundary>2025-01-01T00:00:00</StartBoundary>
            <Enabled>true</Enabled>
            <ScheduleByDay>
              <DaysInterval>1</DaysInterval>
            </ScheduleByDay>
            <RandomDelay>PT30M</RandomDelay>
            <Repetition>
              <Interval>PT1H</Interval>
              <Duration>P1D</Duration>
              <StopAtDurationEnd>false</StopAtDurationEnd>
            </Repetition>
          </CalendarTrigger>
          <EventTrigger>
            <Enabled>true</Enabled>
            <Subscription>&lt;QueryList&gt;&lt;Query Id="0" Path="System"&gt;&lt;Select Path="System"&gt;*[System[Provider[@Name='Microsoft-Windows-GroupPolicy'] and EventID=1502]]&lt;/Select&gt;&lt;/Query&gt;&lt;/QueryList&gt;</Subscription>
          </EventTrigger>
        </Triggers>
      </Task>
    </Properties>
  </TaskV2>

</ScheduledTasks>
